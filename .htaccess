# Redireciona arquivos .html para .php (mantendo compatibilidade com links antigos)
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # Redireciona URLs com /index para a raiz do idioma (remove /index)
    RewriteRule ^(pt|en|es)/(index|home|inicio)$ /$1/ [R=301,L]
    
    # Rotas de internacionalização: /pt/pagina, /en/pagina ou /es/pagina
    # Mapeia para pagina.php?lang=pt, pagina.php?lang=en ou pagina.php?lang=es
    RewriteRule ^(pt|en|es)/(contato|contact|contacto)$ contato.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/(orcamento|budget|presupuesto)$ orcamento.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/(sobre|about)$ sobre.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/(projetos|projects|proyectos)$ projetos.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/(projeto|project|proyecto)$ projeto.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/(contrato|contract)$ contrato.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/(proposta|proposal|propuesta)$ proposta.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/(politica-de-privacidade|privacy-policy|politica-de-privacidad)$ politica-de-privacidade.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/(sucesso|success|exito)$ sucesso.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/?$ index.php?lang=$1 [L,QSA]
    RewriteRule ^(pt|en|es)/404$ 404.php?lang=$1 [L,QSA]
    
    # Redireciona a raiz para /pt/ (português padrão)
    RewriteRule ^$ /pt/ [R=301,L]
    
    # Redireciona URLs antigas sem prefixo de idioma para /pt/ (português padrão)
    # URLs sem extensão (ex: /sobre, /contato)
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^contato$ /pt/contato [R=301,L]
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^orcamento$ /pt/orcamento [R=301,L]
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^sobre$ /pt/sobre [R=301,L]
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^projetos$ /pt/projetos [R=301,L]
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^projeto$ /pt/projeto [R=301,L]
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^contrato$ /pt/contrato [R=301,L]
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^proposta$ /pt/proposta [R=301,L]
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^politica-de-privacidade$ /pt/politica-de-privacidade [R=301,L]
    RewriteCond %{REQUEST_URI} !^/(pt|en|es)/
    RewriteRule ^sucesso$ /pt/sucesso [R=301,L]
    
    # URLs com extensão .php (ex: /sobre.php, /contato.php)
    RewriteRule ^contato\.php$ /pt/contato [R=301,L]
    RewriteRule ^orcamento\.php$ /pt/orcamento [R=301,L]
    RewriteRule ^sobre\.php$ /pt/sobre [R=301,L]
    RewriteRule ^projetos\.php$ /pt/projetos [R=301,L]
    RewriteRule ^projeto\.php$ /pt/projeto [R=301,L]
    RewriteRule ^contrato\.php$ /pt/contrato [R=301,L]
    RewriteRule ^proposta\.php$ /pt/proposta [R=301,L]
    RewriteRule ^politica-de-privacidade\.php$ /pt/politica-de-privacidade [R=301,L]
    RewriteRule ^sucesso\.php$ /pt/sucesso [R=301,L]
    RewriteRule ^index\.php$ /pt/ [R=301,L]
    
    # Redireciona páginas específicas de .html para .php
    RewriteRule ^index\.html$ index.php [R=301,L]
    RewriteRule ^sobre\.html$ sobre.php [R=301,L]
    RewriteRule ^projetos\.html$ projetos.php [R=301,L]
    RewriteRule ^projeto\.html$ projeto.php [R=301,L]
    RewriteRule ^orcamento\.html$ orcamento.php [R=301,L]
    RewriteRule ^contato\.html$ contato.php [R=301,L]
    RewriteRule ^contrato\.html$ contrato.php [R=301,L]
    RewriteRule ^proposta\.html$ proposta.php [R=301,L]
    RewriteRule ^politica-de-privacidade\.html$ politica-de-privacidade.php [R=301,L]
    RewriteRule ^sucesso\.html$ sucesso.php [R=301,L]
</IfModule>

# Define index.php como página padrão
DirectoryIndex index.php

# Página de erro 404
ErrorDocument 404 /404.php

# Protege arquivos sensíveis
<FilesMatch "^(\.htaccess|\.env|composer\.(json|lock)|package(-lock)?\.json)$">
    Require all denied
</FilesMatch>

# Protege diretório src/php/ (endpoints não devem ser acessados diretamente)
# Permite requisições POST para formulários e GET para endpoints AJAX
<IfModule mod_rewrite.c>
    # Permite POST para arquivos de formulário específicos
    RewriteCond %{REQUEST_METHOD} ^POST$ [NC]
    RewriteRule ^src/php/(contactForm|budgetForm|contractForm|finalBudgetForm)\.php$ - [L]
    
    # Permite GET para endpoints AJAX
    RewriteCond %{REQUEST_METHOD} ^GET$ [NC]
    RewriteRule ^src/php/(get-csrf-token|get-errors)\.php$ - [L]
    
    # Bloqueia acesso direto via GET ou outros métodos para o resto do diretório src/php/
    RewriteRule ^src/php/ - [F,L]
</IfModule>

# Habilita compressão GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Cache de arquivos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 year"
</IfModule>

# Configurações PHP
# ATENÇÃO: Em produção, configure display_errors = Off no php.ini do servidor
# Estas configurações são apenas para desenvolvimento local
# Em produção, sempre certifique-se de que session_start() é chamado antes de qualquer output
<IfModule mod_php.c>
    # Descomente as linhas abaixo apenas para desenvolvimento local
    # php_flag display_errors On
    # php_value error_reporting E_ALL & ~E_WARNING & ~E_NOTICE
</IfModule>
